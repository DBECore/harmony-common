---
- name: add tomcat group
  group:
    name: tomcat

- name: add tomcat user
  user:
    name: tomcat
    group: tomcat
    home: /user/share/tomcat
    createhome: no

- name: create /opt/tomcat directory
  file:
    path: /opt/tomcat
    state: directory
  register: tomcat_exists

- name: upload & unarchive tomcat 8
  unarchive:
    src: "{{playbook_dir}}/files/binary/apache-tomcat-8.5.69.tar.gz"
    dest: /opt/tomcat
    extra_opts: [--strip-components=1]
  when: tomcat_exists.changed and tomcat_version == '8'

- name: upload & unarchive tomcat 9
  unarchive:
    src: "{{playbook_dir}}/files/binary/apache-tomcat-9.0.52.tar.gz"
    dest: /opt/tomcat
    extra_opts: [--strip-components=1]
  when: tomcat_exists.changed and tomcat_version == '9'

- name: copy connector jar
  copy:
    src: "{{playbook_dir}}/files/binary/mysql-connector-java-8.0.26.jar"
    dest: /opt/tomcat/lib
  when: tomcat_exists.changed

- name: create custom conf folder
  file:
    path: /opt/tomcat/custom_conf
    state: directory
    owner: tomcat
    group: tomcat
  when: tomcat_exists.changed

- name: copy tomcat startup script
  copy:
    src: "{{setenv_file}}"
    dest: /opt/tomcat/bin
  when: tomcat_exists.changed

- name: delete unnecessary webapps
  file:
    state: absent
    path: /opt/tomcat/webapps
  when: tomcat_exists.changed

- name: recreate empty webapps directory
  file:
    path: /opt/tomcat/webapps
    state: directory
  when: tomcat_exists.changed

- name: change ownership
  file:
    path: /opt/tomcat
    owner: tomcat
    group: tomcat
    mode: "u+rwx,g+rx,o=r"
    recurse: yes
    state: directory
  when: tomcat_exists.changed

- name: copy Tomcat service from local to remote
  copy:
    src: tomcat.service
    dest: /etc/systemd/system/tomcat.service
    mode: 0755
  when: tomcat_exists.changed

- name: start and enable Tomcat service
  systemd:
    name: tomcat
    state: started
    enabled: true
    daemon_reload: true
  when: tomcat_exists.changed
