- hosts: localhost
  gather_facts: no
  roles:
    - role: local
      vars:
        tomcat_version: '8'
  tasks:
    - name: check BDMSL war exists
      stat:
        path: "{{playbook_dir}}/files/binary/bdmsl-webapp-4.1.0.war"
      register: bdmslwar

    - name: download BDMSL to local cache
      get_url:
        url: https://ec.europa.eu/cefdigital/artifact/repository/public/eu/europa/ec/bdmsl/bdmsl-webapp/4.1.0/bdmsl-webapp-4.1.0.war
        dest: "{{playbook_dir}}/files/binary/bdmsl-webapp-4.1.0.war"
      when: not bdmslwar.stat.exists

- hosts: lxd_servers
  roles:
    - init-lxd

- hosts: bdmsl_servers
  become: yes
  roles:
    - common
    - mysql
    - role: tomcat
      vars:
        tomcat_version: '8'
        setenv_file: "{{playbook_dir}}/files/bdmsl/setenv.sh"
    - bind9
    - private_dns
  vars:
    private_dns: 127.0.0.1
  tasks:
    - name: collect info about database
      mysql_info:
        login_user: root
        login_password: root
      register: db_state

    - name: copy ddl file
      copy:
        src: "{{playbook_dir}}/files/bdmsl/bdsml_schema.ddl"
        dest: /root
      when: db_state.databases.bdmsl is not defined

    - name: create database
      mysql_db:
        name: bdmsl
        state: import
        encoding: utf8
        login_user: root
        login_password: root
        target: /root/bdsml_schema.ddl
      when: db_state.databases.bdmsl is not defined

    - name: copy db settings file
      copy:
        src: "{{playbook_dir}}/files/bdmsl/bdsml_configuration.sql"
        dest: /root
        force: true

    - name: load settings into db
      mysql_db:
        name: bdmsl
        state: import
        encoding: utf8
        login_user: root
        login_password: root
        target: /root/bdsml_configuration.sql

    - name: prepare smp subdomains sql file
      with_inventory_hostnames: smp_servers
      lineinfile:
        path: /root/certificate_domains.sql
        create: true
        regexp: ".*CN={{item}}"
        line: INSERT INTO bdmsl_certificate_domain(certificate, crl_url, fk_subdomain_id, created_on, last_updated_on, is_root_ca, is_admin) VALUES ('CN={{item}},O=NIIS,C=FI','', 1, NOW(), NOW(), 0, 1);

    - name: add bdmsl_certificate_domain records
      mysql_db:
        name: bdmsl
        state: import
        encoding: utf8
        login_user: root
        login_password: root
        target: /root/certificate_domains.sql

    - name: create sml folder
      file:
        path: /opt/smlconf
        state: directory
        owner: tomcat
        group: tomcat
      when: tomcat_exists.changed

    - name: create conf folder
      file:
        path: /opt/tomcat/custom_conf
        state: directory
        owner: tomcat
        group: tomcat

    - name: copy bdsml conf file
      copy:
        src: "{{playbook_dir}}/files/bdmsl/sml.config.properties"
        dest: /opt/tomcat/custom_conf
        force: true
        owner: tomcat
        group: tomcat

    - name: copy bdsml context.xml file
      copy:
        src: "{{playbook_dir}}/files/bdmsl/bdmsl_context.xml"
        dest: /opt/tomcat/conf/context.xml
        force: true
        owner: tomcat
        group: tomcat

    - name: copy bdsml war to webapps
      copy:
        src: "{{playbook_dir}}/files/binary/bdmsl-webapp-4.1.0.war"
        dest: /opt/tomcat/webapps/ROOT.war
        owner: tomcat
        group: tomcat

